"use strict";(self.webpackChunkgwiyeom_blog=self.webpackChunkgwiyeom_blog||[]).push([[9841],{4641:function(e,t,n){n.r(t),n.d(t,{Head:function(){return p.F},default:function(){return c}});var l=n(7294),o=n(1151);function a(e){const t=Object.assign({h1:"h1",p:"p",a:"a",h3:"h3",code:"code",blockquote:"blockquote",pre:"pre",ul:"ul",li:"li",ol:"ol",span:"span"},(0,o.ah)(),e.components);return l.createElement(l.Fragment,null,l.createElement(t.h1,null,"배경"),"\n",l.createElement(t.p,null,"인프라팀에서 자체적으로 apm 을 만들었고\n실행결과 특정 서비스가 메모리를 많이 사용하고 있다고 알게되었다\n고쳐야하는데\n어디서 많이 누수가 발생하는지 모르겠다"),"\n",l.createElement(t.p,null,l.createElement(t.a,{href:"https://www.nylas.com/blog/finding-memory-leak-in-go-service-dev/"},"링크1"),"\n를 통해 어디에서 메모리를 많이 사용할 수 있는지 알 수 잇다고 한다"),"\n",l.createElement(t.h1,null,"Profile 정보 수집"),"\n",l.createElement(t.h3,null,'(1) "net/http/pprof"'),"\n",l.createElement(t.p,null,l.createElement(t.a,{href:"https://ssup2.github.io/programming/Golang_Profiling/?ref=pangyoalto.com"},"http.HandleFunc 으로 핸들러를 구현한 경우"),"를 인터넷에서 봤고 지금사용하는\nehco 프레임워크에 적용하는 방법\n",l.createElement(t.code,null,'e.GET("/debug/pprof/*", echo.WrapHandler(http.DefaultServeMux))')," 를 추가"),"\n",l.createElement(t.blockquote,null,"\n",l.createElement(t.p,null,"Profile File 정보 얻기"),"\n"),"\n",l.createElement(t.p,null,"CPU 정보"),"\n",l.createElement(t.pre,null,l.createElement(t.code,null,"curl http://localhost:8080/debug/pprof/profile > profile.pprof\n")),"\n",l.createElement(t.p,null,"Memory Heap 정보"),"\n",l.createElement(t.pre,null,l.createElement(t.code,null,"curl http://localhost:8080/debug/pprof/heap > heap.pprof\n")),"\n",l.createElement(t.p,null,"모든 HTTP Endpoint에 seconds Query String를 이용하면 몇 초 동안 Profiling을 수행할지 설정"),"\n",l.createElement(t.pre,null,l.createElement(t.code,null," curl http://localhost:8080/debug/pprof/trace\\?seconds\\=30 --output trace.out\n")),"\n",l.createElement(t.h3,null,"(2) ",l.createElement(t.a,{href:"https://ssup2.github.io/programming/Golang_Profiling/?ref=pangyoalto.com"},"다른방법들..")),"\n",l.createElement(t.p,null,l.createElement(t.code,null,"runtime/pprof Package")," , ",l.createElement(t.code,null,"Unit Test")," 등등.."),"\n",l.createElement(t.h1,null,"Profile 시각화 보기"),"\n",l.createElement(t.p,null,"pprof 도구로 profile 파일을 다운받기\n",l.createElement(t.code,null,"go tool pprof [-http옵션][Profile File]")),"\n",l.createElement(t.p,null,l.createElement(t.code,null,"go tool pprof heap.pprof"),"\n",l.createElement(t.code,null,"go tool pprof -http :8080 heap.pprof"),"\n",l.createElement(t.code,null,"go tool pprof http://0.0.0.0:8080/debug/pprof/heap")),"\n",l.createElement(t.p,null,"커맨드를 사용해 시각화 해서 볼 수 있음\ngraphviz 그래프 기반의 dot 파일로 기술된 다양한 이미지를 쉽게 시각화할 수 있는 패키지\ngraphviz 설치해야 시각화된 정보를 얻을 수 있음"),"\n",l.createElement(t.ul,null,"\n",l.createElement(t.li,null,"mac 에서 다운받기\n",l.createElement(t.code,null,"brew install graphviz")),"\n"),"\n",l.createElement(t.p,null,"command 에서 아래 명령어로 분석가능"),"\n",l.createElement(t.p,null,l.createElement(t.code,null,"(prof) web"),"\n커멘드 창에 web 을 입력시 web 에서 그래프를 볼 수 있음"),"\n",l.createElement(t.p,null,l.createElement(t.code,null,"(pprof) png")," => 이미지 생성해서 받을 수 있음\nGenerating report in profile001.png"),"\n",l.createElement(t.p,null,l.createElement(t.code,null,"(pprof) top15")),"\n",l.createElement(t.ol,null,"\n",l.createElement(t.li,null,"수집한 profile data 시각화"),"\n"),"\n",l.createElement(t.p,null,"180초 동안 수집한 profile data 다운\n",l.createElement(t.code,null,"curl http://localhost:8080/debug/pprof/profile\\?seconds\\=180 --output profile.out")),"\n",l.createElement(t.p,null,l.createElement(t.code,null,"go tool pprof -http localhost:9090 profile.out")),"\n",l.createElement(t.p,null,"=> 해당 명령을 실행하면 web 에서 view > top 에서  CPU 사용률이 높은 함수를 순서를 보여준다"),"\n",l.createElement(t.ol,{start:"2"},"\n",l.createElement(t.li,null,"수집한 profile trace 보기"),"\n"),"\n",l.createElement(t.p,null,l.createElement(t.code,null,"curl http://localhost:8080/debug/pprof/trace\\?seconds\\=180 --output trace.out"),"\n9090 포트로 실행\n",l.createElement(t.code,null,"go tool trace -http localhost:9090 trace.out"),"\n",l.createElement(t.span,{dangerouslySetInnerHTML:{__html:'<span\n      class="gatsby-resp-image-wrapper"\n      style="position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 924px; "\n    >\n      <span\n    class="gatsby-resp-image-background-image"\n    style="padding-bottom: 89.16666666666667%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAASCAYAAABb0P4QAAAACXBIWXMAAAsTAAALEwEAmpwYAAACX0lEQVR42n2U6ZaiQAyFff8nszeXRkQFFAQFxXW0XXrL8IUJQ/9pz7knSxWpJDexNZ9HMhw6EseRjEYj8X1fgiCQyWQi4/FYwjCU7+/vX9H8teJ4J66byWQcSJomst1uZbVayXq9Vj3Pc9lsNrLf72scj0fZ7Xa1/fHx8T9gGCbieaFmF4aBzOdzzXI6naqPD/l9fX39yArb8CPD6/Uiq2QjxXIv1+tVbrebXC4XeXt7k/P5LPf7XT/6/Pz8FRa4FUWROM5ARt5Iewbon+d5ZW+HKgeDQe0na0Oz1zxeB/SDqkQODbPZrPbRgqIotK/0E2DTDtNPp1MVkAza7bb0ej15fHyUp6cneXl5kefnZ/U9PDzUNufdbleBjb/T6ajONFB2K01TLQuQDWVwSFaWnZVmOiBbMiNDWKfXkNXKskwomxKRsExAbCQ2fnRkHMfaCiRn3CMpHtCAvEwJrutqif1+X+Xr6+sPCSxLG3iIgThsEvs32LFe4kJNjG9bEtQlgiRJFMvlUgfeQDDK1x7ykTfyFH4ZiEyH7lAGjivesOotPkYHoOOzrAxsjAaE+mg2lzRZllhIsS5klW6lyPayyQ6SZ2vJV7lmxUoybywAYPhtGepNgaE4WEjkL0q5LGeL/dzJ4XDQOUMauIts7jSSneeukjItWXIGTrktZfP7XZ0tCHAcR+cLkiCtIqfSjTh05pAWwIWWDO2Q8n5/11kifYBudlNvwnzNP4gWrMGgNZdemVwsFrWfWUvTPyWrZU/zTNltnlO6BoQtyrQy0CnPBpoHqaJCNcw21HaODWH08C/+VC110RIgZAAAAABJRU5ErkJggg==\'); background-size: cover; display: block;"\n  ></span>\n  <img\n        class="gatsby-resp-image-image"\n        alt="img"\n        title=""\n        src="/static/275044a153e5f0b30350db08a0b58aa1/e5e56/go_trace_ex.png"\n        srcset="/static/275044a153e5f0b30350db08a0b58aa1/5243c/go_trace_ex.png 240w,\n/static/275044a153e5f0b30350db08a0b58aa1/ab158/go_trace_ex.png 480w,\n/static/275044a153e5f0b30350db08a0b58aa1/e5e56/go_trace_ex.png 924w"\n        sizes="(max-width: 924px) 100vw, 924px"\n        style="width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;"\n        loading="lazy"\n        decoding="async"\n      />\n    </span>'}}),"\n",l.createElement(t.a,{href:"https://pangyoalto.com/go-using-pprof-for-profiing/"},"링크2")),"\n",l.createElement(t.h1,null,"분석"),"\n",l.createElement(t.h3,null,"(Flat,cum )[",l.createElement(t.a,{href:"https://ssup2.github.io/programming/Golang_Profiling/"},"https://ssup2.github.io/programming/Golang_Profiling/"),"]"),"\n",l.createElement(t.p,null,"flat is duration spent on given a function and\ncum is cumulative of current function plus calls above it"),"\n",l.createElement(t.p,null,"Flat은 함수가 직접적으로 수행하는 Action의 부하\nCum은 함수가 실행되기 위한 모든 Action의 부하"),"\n",l.createElement(t.p,null,"sum% could help you to identify the big rocks quickly. The following is another example of memory allocation report.\nsum% = 메모리 사용률\n메모리 사용률(sum) 이 100% 가 되지 않는 상황"),"\n",l.createElement(t.p,null,"누수는 프로그램이 더 이상 필요하지 않은 메모리를 해제하지 않아 발생하며, 이로 인해 메모리 사용량이 계속해서 증가..\n",l.createElement(t.a,{href:"https://stackoverflow.com/questions/32571396/pprof-and-golang-how-to-interpret-a-results"},"https://stackoverflow.com/questions/32571396/pprof-and-golang-how-to-interpret-a-results"),"\n",l.createElement(t.a,{href:"https://ssup2.github.io/programming/Golang_Profiling/"},"https://ssup2.github.io/programming/Golang_Profiling/")),"\n",l.createElement(t.p,null,"출력된 그래프를 읽는방법\n",l.createElement(t.a,{href:"https://github.com/google/pprof/blob/main/doc/README.md#interpreting-the-callgraph"},"https://github.com/google/pprof/blob/main/doc/README.md#interpreting-the-callgraph")),"\n",l.createElement(t.p,null,"--\n질문.. 로컬에서는 실행해서 데이터를 확인했는데..\n실제 운영 환경에서 어떻게 파일을 받고 열지 찾아보기"),"\n",l.createElement(t.p,null,l.createElement(t.a,{href:"https://github.com/google/gops"},"https://github.com/google/gops"),"\n",l.createElement(t.a,{href:"https://pangyoalto.com/go-using-pprof-for-profiing/"},"https://pangyoalto.com/go-using-pprof-for-profiing/"),"\n",l.createElement(t.a,{href:"https://ssup2.github.io/programming/Golang_Profiling/?ref=pangyoalto.com"},"https://ssup2.github.io/programming/Golang_Profiling/?ref=pangyoalto.com")))}var r=function(e){void 0===e&&(e={});const{wrapper:t}=Object.assign({},(0,o.ah)(),e.components);return t?l.createElement(t,e,l.createElement(a,e)):a(e)},p=n(8804);function c(e){return l.createElement(p.Z,e,l.createElement(r,e))}p.Z}}]);
//# sourceMappingURL=component---node-modules-lekoarts-gatsby-theme-minimal-blog-core-src-templates-post-query-tsx-content-file-path-content-posts-server-golang-2023-08-16-go-profiling-memory-mdx-4431e3e053ec83da62d0.js.map