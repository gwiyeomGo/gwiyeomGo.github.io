---
title: json 데이터 replace,insert 경험 (How to replace JSON data in MySQL?)
date: 2023-01-03
slug: "/database/mysql/2023-01-03-mysql-jsonData-replace-and-insert"
tags:
  - MYSQL
---

### 배경

어드민 서비스 와 기부 서비스는 분리되어 있습니다.
어드민 서비스에 조직도


### 개선 내용

|id|name|connect|
|---|---|---|
|1|강동|'{"code":"200122"}'|


### json data 를 replace 해서 조회하기

* 기존의 connect 컬럼의 json string 데이터의 code key 값을 변경
```
select id, name, json_replace(connect, '$.code', "300123") from employees where id = 1;
```
|id|name|connect|
|---|---|---|
|1|강동|'{"code":"300123"}'|

### json data 에 key 와 value 추가 해서 조회하기

```
select id, name, JSON_INSERT(connect, '$.type', "STORE") from employees where id = 1;
```

|id|name|connect|
|---|---|---|
|1|강동|'{"code":"200122","type":"STORE"}'|


### json data 에 key 와 value 추가해서 table update

```
UPDATE test
set `connect` =
JSON_INSERT(connect, '$.type', 'STORE')
where id = 1;
```



### 작업을하다가 ... 기능 개발로 기존 data 를 바꿔야 하는 상황...

|id|name|connect|
|---|---|---|
|1|강동|'{"code":"100008"}'|
|2|군포|'{"code":"200122"}'|
|3|대전|'{"code":"200026"}'|

code 가 1로 시작하면 type "CENTER" 로 update
code 가 2로 시작하면 type "STORE" 로 update


이렇게 Where 절에서 JSON_EXTRACT 에 `>=` 와 `<` 로 100000 이상 200000 미만인 경우 CENTER 로 type 을 추가
```
UPDATE test
 set `connect` = JSON_replace(connect, '$.type', 'CENTER')
WHERE JSON_EXTRACT(connect, '$.code') >= '100000' AND  JSON_EXTRACT(connect, '$.code') <'200000';
```

이렇게  경우에 따라 update 를 추가하면 귀찮으니 한번에 업데이트 하려면?
`case when `을 사용해 보자


```
UPDATE test
 SET `connect` =
 CASE
 WHEN JSON_EXTRACT(connect, '$.code') <'200000'
	THEN  JSON_insert(connect, '$.type', 'CENTER')
 WHEN JSON_EXTRACT(connect, '$.code') >= '200000'
	THEN  JSON_insert(connect, '$.type', 'STORE')
END;
```
이렇게 하면 조건에 따라 update 된다.

### [JSON_SET() vs JSON_INSERT() vs JSON_REPLACE() in MySQL: What’s the Difference?](https://database.guide/json_set-vs-json_insert-vs-json_replace-in-mysql-whats-the-difference/)

> * JSON_SET() replaces existing values and adds nonexisting values.
  * JSON_INSERT() inserts values without replacing existing values.
  * JSON_REPLACE() replaces only existing values.

JSON_SET 는 데이터가 존재하지 않는 컬럼에도 값을 추가한다


### 참고
https://stackoverflow.com/questions/36264369/mysql-5-7-appending-key-value-to-nested-json-object