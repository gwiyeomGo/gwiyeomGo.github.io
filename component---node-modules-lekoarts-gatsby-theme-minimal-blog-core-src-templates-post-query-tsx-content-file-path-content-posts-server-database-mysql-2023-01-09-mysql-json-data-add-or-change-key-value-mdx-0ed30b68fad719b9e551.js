"use strict";(self.webpackChunkgwiyeom_blog=self.webpackChunkgwiyeom_blog||[]).push([[8856],{2762:function(e,n,t){t.r(n),t.d(n,{Head:function(){return u.p},default:function(){return E}});var l=t(6540),c=t(8453);function r(e){const n=Object.assign({h3:"h3",p:"p",blockquote:"blockquote",table:"table",thead:"thead",tr:"tr",th:"th",tbody:"tbody",td:"td",code:"code",a:"a",ul:"ul",li:"li",pre:"pre",h1:"h1"},(0,c.RP)(),e.components);return l.createElement(l.Fragment,null,l.createElement(n.h3,null,"배경"),"\n",l.createElement(n.p,null,"어드민 회원을 관리하는 서비스와 매장을 관리하는 서비스를 분리해서 사용하고 있다.\n어드민 회원 관리 서비스에서 매장의 정보를 code 로 연결해서 사용하고 있다.\n어드민 회원의 역할/조직 매칭 기능이 이후 개발되면서\n연결 정보에 type 도 추가해 기존 데이터를 바꿔야 하는 문제가 있었다."),"\n",l.createElement(n.blockquote,null,"\n",l.createElement(n.p,null,"(매장을 관리하는 서비스의 sites talbe)"),"\n"),"\n",l.createElement(n.table,null,l.createElement(n.thead,null,l.createElement(n.tr,null,l.createElement(n.th,null,"id"),l.createElement(n.th,null,"code"),l.createElement(n.th,null,"name"))),l.createElement(n.tbody,null,l.createElement(n.tr,null,l.createElement(n.td,null,"1"),l.createElement(n.td,null,"200122"),l.createElement(n.td,null,"강동")),l.createElement(n.tr,null,l.createElement(n.td,null,"2"),l.createElement(n.td,null,"100121"),l.createElement(n.td,null,"부산")))),"\n",l.createElement(n.blockquote,null,"\n",l.createElement(n.p,null,"(기존 조직 table 코드)"),"\n"),"\n",l.createElement(n.table,null,l.createElement(n.thead,null,l.createElement(n.tr,null,l.createElement(n.th,null,"id"),l.createElement(n.th,null,"name"),l.createElement(n.th,null,"connect"))),l.createElement(n.tbody,null,l.createElement(n.tr,null,l.createElement(n.td,null,"1"),l.createElement(n.td,null,"강동"),l.createElement(n.td,null,l.createElement(n.code,null,'{"code":"200122"}'),"'`")),l.createElement(n.tr,null,l.createElement(n.td,null,"2"),l.createElement(n.td,null,"부산"),l.createElement(n.td,null,l.createElement(n.code,null,'{"code":"100121"}'),"'`")))),"\n",l.createElement(n.blockquote,null,"\n",l.createElement(n.p,null,"(변경 조직 table 코드)"),"\n"),"\n",l.createElement(n.table,null,l.createElement(n.thead,null,l.createElement(n.tr,null,l.createElement(n.th,null,"id"),l.createElement(n.th,null,"name"),l.createElement(n.th,null,"connect"))),l.createElement(n.tbody,null,l.createElement(n.tr,null,l.createElement(n.td,null,"1"),l.createElement(n.td,null,"강동"),l.createElement(n.td,null,l.createElement(n.code,null,'{"code":"200122","type":"store"}'))),l.createElement(n.tr,null,l.createElement(n.td,null,"2"),l.createElement(n.td,null,"부산"),l.createElement(n.td,null,l.createElement(n.code,null,'{"code":"100121","type":"center"}'))))),"\n",l.createElement(n.h3,null,"어떻게 json 값에 새로운 key 를 추가할 수 있을까?"),"\n",l.createElement(n.p,null,l.createElement(n.a,{href:"https://database.guide/json_set-vs-json_insert-vs-json_replace-in-mysql-whats-the-difference/"},"JSON_SET() vs JSON_INSERT() vs JSON_REPLACE() in MySQL: What’s the Difference?")),"\n",l.createElement(n.blockquote,null,"\n",l.createElement(n.ul,null,"\n",l.createElement(n.li,null,"JSON_SET() replaces existing values and adds nonexisting values."),"\n"),"\n"),"\n",l.createElement(n.ul,null,"\n",l.createElement(n.li,null,"JSON_INSERT() inserts values without replacing existing values."),"\n",l.createElement(n.li,null,"JSON_REPLACE() replaces only existing values."),"\n"),"\n",l.createElement(n.p,null,"JSON_SET 는 데이터가 존재하지 않는 컬럼에도 값을 추가한다"),"\n",l.createElement(n.h3,null,"단건으로 생각해보기"),"\n",l.createElement(n.ul,null,"\n",l.createElement(n.li,null,"json data 에 key 와 value 추가 해서 조회하기 (데이터는 바뀌지 않음)"),"\n"),"\n",l.createElement(n.pre,null,l.createElement(n.code,null,"select id, name, JSON_INSERT(connect, '$.type', \"store\") from employees where id = 1;\n")),"\n",l.createElement(n.ul,null,"\n",l.createElement(n.li,null,"변경하려면 update 를 사용한다"),"\n"),"\n",l.createElement(n.pre,null,l.createElement(n.code,null,"UPDATE sites\nset `connect` =\nJSON_INSERT(connect, '$.type', 'store')\nwhere id = 1;\n")),"\n",l.createElement(n.table,null,l.createElement(n.thead,null,l.createElement(n.tr,null,l.createElement(n.th,null,"id"),l.createElement(n.th,null,"name"),l.createElement(n.th,null,"connect"))),l.createElement(n.tbody,null,l.createElement(n.tr,null,l.createElement(n.td,null,"1"),l.createElement(n.td,null,"강동"),l.createElement(n.td,null,l.createElement(n.code,null,'{"code":"200122","type":"store"}'))))),"\n",l.createElement(n.ul,null,"\n",l.createElement(n.li,null,"그렇다면 기존의 json 내부의 특정 key 의 value 를 바꾸려면?"),"\n"),"\n",l.createElement(n.pre,null,l.createElement(n.code,null,"select id, name, json_replace(connect, '$.code', \"300123\") from employees where id = 1;\n")),"\n",l.createElement(n.table,null,l.createElement(n.thead,null,l.createElement(n.tr,null,l.createElement(n.th,null,"id"),l.createElement(n.th,null,"name"),l.createElement(n.th,null,"connect"))),l.createElement(n.tbody,null,l.createElement(n.tr,null,l.createElement(n.td,null,"1"),l.createElement(n.td,null,"강동"),l.createElement(n.td,null,l.createElement(n.code,null,'{"code":"300123","type":"store"}'))))),"\n",l.createElement(n.h3,null,"실전"),"\n",l.createElement(n.p,null,'code 가 1로 시작하면 type "center" 로 update\ncode 가 2로 시작하면 type "store" 로 update'),"\n",l.createElement(n.p,null,"이렇게 Where 절에서 JSON_EXTRACT 에 ",l.createElement(n.code,null,">=")," 와 ",l.createElement(n.code,null,"<")," 로 100000 이상 200000 미만인 경우 CENTER 로 type 을 추가"),"\n",l.createElement(n.pre,null,l.createElement(n.code,null,"UPDATE test\n set `connect` = JSON_replace(connect, '$.type', 'center')\nWHERE JSON_EXTRACT(connect, '$.code') >= '100000' AND  JSON_EXTRACT(connect, '$.code') <'200000';\n")),"\n",l.createElement(n.p,null,"이렇게  경우에 따라 update 를 추가하면 귀찮으니 한번에 업데이트 하려면?\n",l.createElement(n.code,null,"case when "),"을 사용해 보자"),"\n",l.createElement(n.pre,null,l.createElement(n.code,null,"UPDATE test\n SET `connect` =\n CASE\n WHEN JSON_EXTRACT(connect, '$.code') <'200000'\n\tTHEN  JSON_insert(connect, '$.type', 'center')\n WHEN JSON_EXTRACT(connect, '$.code') >= '200000'\n\tTHEN  JSON_insert(connect, '$.type', 'store')\nEND;\n")),"\n",l.createElement(n.p,null,"이렇게 하면 조건에 따라 update 된다."),"\n",l.createElement(n.h1,null,"실전2"),"\n",l.createElement(n.p,null,"처음에 code 의 20000 이라는 매장,이후는 center 로 썼었는데 나중에 등록된 매장이 추가되면서 규칙이 깨졌다는 사실을 알게 되었다....\n그래서 sites 의 code 와 일치하는 데이터를 찾아서 type 을 변경하도록 쿼리를 수정했다."),"\n",l.createElement(n.pre,null,l.createElement(n.code,null,"start transaction;\n\nSELECT * FROM A.organizations as o\n        inner join B.sites as s\n            on replace(connect -> '$.code','\"','') =   s.code; -- (1) (2)\n\n\n\nUPDATE A.organizations as o\n        inner join  B.sites as s\n            on replace(connect -> '$.siteCode','\"','') =   s.code\nset o.connect = (\n    CASE\n    WHEN  s.type = 'center'\n    THEN  JSON_insert(connect, '$.type', 'center')\n    WHEN  s.type = 'store'\n    THEN  JSON_insert(connect, '$.type', 'store')\n    WHEN  s.type = 'team'\n    THEN  JSON_insert(connect, '$.type', 'team')\nEND);\n-- commit;\n-- rollback;\n\n")),"\n",l.createElement(n.ul,null,"\n",l.createElement(n.li,null,"(1) replace('문자열','기존문자열','변경문자열')"),"\n",l.createElement(n.li,null,"(2) connect -> '$.code' 는 json 안에 code 를 가리킨다"),"\n"),"\n",l.createElement(n.h3,null,"20230112"),"\n",l.createElement(n.p,null,"실제로 해당 쿼리를 운영 db 에 실행하니 어떤 row 에 지정하는 명확하지 않아서 추가되지 않았다\n마지막 ) 뒤에 ",l.createElement(n.code,null,"where o.id  > 0")," 로 전체 row 를 지정하셨다고 한다"),"\n",l.createElement(n.h3,null,"참고"),"\n",l.createElement(n.p,null,l.createElement(n.a,{href:"https://stackoverflow.com/questions/36264369/mysql-5-7-appending-key-value-to-nested-json-object"},"https://stackoverflow.com/questions/36264369/mysql-5-7-appending-key-value-to-nested-json-object")))}var a=function(e){void 0===e&&(e={});const{wrapper:n}=Object.assign({},(0,c.RP)(),e.components);return n?l.createElement(n,e,l.createElement(r,e)):r(e)},u=t(7292);function E(e){return l.createElement(u.A,e,l.createElement(a,e))}u.A}}]);
//# sourceMappingURL=component---node-modules-lekoarts-gatsby-theme-minimal-blog-core-src-templates-post-query-tsx-content-file-path-content-posts-server-database-mysql-2023-01-09-mysql-json-data-add-or-change-key-value-mdx-0ed30b68fad719b9e551.js.map