"use strict";(self.webpackChunkgwiyeom_blog=self.webpackChunkgwiyeom_blog||[]).push([[9841],{6221:function(e,t,n){n.r(t),n.d(t,{Head:function(){return p.F},default:function(){return c}});var l=n(7294),r=n(1151);function o(e){const t=Object.assign({h1:"h1",p:"p",a:"a",hr:"hr",h3:"h3",code:"code",blockquote:"blockquote",ul:"ul",li:"li",ol:"ol",span:"span"},(0,r.ah)(),e.components);return l.createElement(l.Fragment,null,l.createElement(t.h1,null,"배경"),"\n",l.createElement(t.p,null,"인프라팀에서 자체적으로 apm 을 만들었고\r\n실행결과 특정 서비스가 메모리를 많이 사용하고 있다고 알게되었다\r\n고쳐야하는데\r\n어디서 많이 누수가 발생하는지 모르겠다"),"\n",l.createElement(t.p,null,l.createElement(t.a,{href:"https://www.nylas.com/blog/finding-memory-leak-in-go-service-dev/"},"링크1"),"\r\n를 통해 어디에서 메모리를 많이 사용할 수 있는지 알 수 잇다고 한다"),"\n",l.createElement(t.hr),"\n",l.createElement(t.h1,null,"Profile 정보 수집"),"\n",l.createElement(t.h3,null,'(1) "net/http/pprof"'),"\n",l.createElement(t.p,null,l.createElement(t.a,{href:"https://ssup2.github.io/programming/Golang_Profiling/?ref=pangyoalto.com"},"http.HandleFunc 으로 핸들러를 구현한 경우"),"를 인터넷에서 봤고 지금사용하는\r\nehco 프레임워크에 적용하는 방법\r\n",l.createElement(t.code,null,'e.GET("/debug/pprof/*", echo.WrapHandler(http.DefaultServeMux))')," 를 추가"),"\n",l.createElement(t.blockquote,null,"\n",l.createElement(t.p,null,"Profile File 정보 얻기"),"\n"),"\n",l.createElement(t.blockquote,null,"\n",l.createElement(t.p,null,"CPU 사용 정보\r\n",l.createElement(t.code,null,"curl http://localhost:8080/debug/pprof/profile > profile.pprof")),"\n"),"\n",l.createElement(t.blockquote,null,"\n",l.createElement(t.p,null,"Memory Heap 정보 => 메모리 리스크 확인시 (type: inuse_space)\r\n",l.createElement(t.code,null,"curl http://localhost:8080/debug/pprof/heap > heap.pprof")),"\n"),"\n",l.createElement(t.blockquote,null,"\n",l.createElement(t.p,null,"모든 HTTP Endpoint에 seconds Query String를 이용하면 몇 초 동안 Profiling을 수행할지 설정\r\n",l.createElement(t.code,null," curl http://localhost:8080/debug/pprof/trace\\?seconds\\=30 --output trace.out")),"\n"),"\n",l.createElement(t.h3,null,"(2) ",l.createElement(t.a,{href:"https://ssup2.github.io/programming/Golang_Profiling/?ref=pangyoalto.com"},"다른방법들..")),"\n",l.createElement(t.p,null,l.createElement(t.code,null,"runtime/pprof Package")," , ",l.createElement(t.code,null,"Unit Test")," 등등.."),"\n",l.createElement(t.hr),"\n",l.createElement(t.h1,null,"Profile 시각화 보기"),"\n",l.createElement(t.p,null,"pprof 도구로 profile 파일을 다운받기\r\n",l.createElement(t.code,null,"go tool pprof [-http옵션][Profile File]")),"\n",l.createElement(t.p,null,l.createElement(t.code,null,"go tool pprof heap.pprof"),"\r\n",l.createElement(t.code,null,"go tool pprof -http :8080 heap.pprof"),"\r\n",l.createElement(t.code,null,"go tool pprof http://0.0.0.0:8080/debug/pprof/heap")),"\n",l.createElement(t.p,null,"커맨드를 사용해 시각화 해서 볼 수 있음\r\ngraphviz 그래프 기반의 dot 파일로 기술된 다양한 이미지를 쉽게 시각화할 수 있는 패키지\r\ngraphviz 설치해야 시각화된 정보를 얻을 수 있음"),"\n",l.createElement(t.ul,null,"\n",l.createElement(t.li,null,"mac 에서 다운받기\r\n",l.createElement(t.code,null,"brew install graphviz")),"\n",l.createElement(t.li,null,"windows\r\n",l.createElement(t.code,null,"winget install graphviz")),"\n"),"\n",l.createElement(t.p,null,l.createElement(t.a,{href:"https://graphviz.org/download/"},"https://graphviz.org/download/")," 통해서 설치\r\ncommand 에서 아래 명령어로 분석가능"),"\n",l.createElement(t.p,null,l.createElement(t.code,null,"(prof) web"),"\r\n커멘드 창에 web 을 입력시 web 에서 그래프를 볼 수 있음"),"\n",l.createElement(t.p,null,l.createElement(t.code,null,"(pprof) png")," => 이미지 생성해서 받을 수 있음\r\nGenerating report in profile001.png"),"\n",l.createElement(t.p,null,l.createElement(t.code,null,"(pprof) top15")),"\n",l.createElement(t.ol,null,"\n",l.createElement(t.li,null,"수집한 profile data 시각화"),"\n"),"\n",l.createElement(t.p,null,"180초 동안 수집한 profile data 다운\r\n",l.createElement(t.code,null,"curl http://localhost:8080/debug/pprof/profile\\?seconds\\=180 --output profile.out")),"\n",l.createElement(t.p,null,l.createElement(t.code,null,"go tool pprof -http localhost:9090 profile.out")),"\n",l.createElement(t.p,null,"=> 해당 명령을 실행하면 web 에서 view > top 에서  CPU 사용률이 높은 함수를 순서를 보여준다"),"\n",l.createElement(t.ol,{start:"2"},"\n",l.createElement(t.li,null,"수집한 profile trace 보기"),"\n"),"\n",l.createElement(t.p,null,l.createElement(t.code,null,"curl http://localhost:8080/debug/pprof/trace\\?seconds\\=180 --output trace.out"),"\r\n9090 포트로 실행\r\n",l.createElement(t.code,null,"go tool trace -http localhost:9090 trace.out"),"\r\n",l.createElement(t.span,{dangerouslySetInnerHTML:{__html:'<span\n      class="gatsby-resp-image-wrapper"\n      style="position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 924px; "\n    >\n      <span\n    class="gatsby-resp-image-background-image"\n    style="padding-bottom: 89.16666666666667%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAASCAYAAABb0P4QAAAACXBIWXMAAAsTAAALEwEAmpwYAAACUElEQVR42n2TiY7iQAxE+f8vQ8NNCIEcnCEkhHM5AuLw5pnpHjTSLlLJbsdtyi53ZTabiOe5Mp1OZTgcShiGEkWRBEGg59FoJK/X67/4/FUmk6247rK8HMp8Ppf1ei1pmspqtbI+drfbWRwOB9lut/Z8v99/CkbRvGQYyWAwUHaz2UzZwYzYZrPRxOfzaQGr39YWLIqLZPO15MudXK9Xud1ucrlc5Hw+Kzhz6fF4/BMwJOe75Yk4Tk8G3lB837fwPM+i1+vpPInDGh8wa2L4p9Ppp6Bp0fcD9Ukaj8ffMV9jeZ7buQLOzNH4x+PxXRAG1WpV2u221Go1qdfr0mw2pdFoaOzr60t9wPdWq6XgTJ7xYUvblTiObWtQh83n2mAR69MHWZYpY9jt93udNeJUlsulbY/2UZkLxCjMfhLHx3ImF0sueZCiuBZkRtB2XVdb7HQ6im63q2fHcdQCM08jCALRGXGIWVEIwMqI4PtvFcMotC2aHWX5kyTRAoDFx9K6zpBL3uA9Qz/wdUVct6+r1O97CtgThy0+ubAzRQEvRgsi/WQ0lXielFiUs8glizeSJztZL/eSJpmkWaqsEIJ9K4rCLj8+sC+FdzkNFzIJFqVNyt3ifW5VOf4M+xuw4Rt38XmenFWU8XhUtuNI1+lIu9Oy+4co7CQCIZoRCd9YwC4yAlTXlpEd5dgj3jL0zZs2MXO+XgubY/KAecfaMqqhoFHu0y4WCzt0di2O/5Sq5qos+PxOy1qQ9TBtAnzaY0VYKf6QLt54L7NZavOdM4Ixw7/7ey02tpoh6QAAAABJRU5ErkJggg==\'); background-size: cover; display: block;"\n  ></span>\n  <img\n        class="gatsby-resp-image-image"\n        alt="img"\n        title=""\n        src="/static/275044a153e5f0b30350db08a0b58aa1/e5e56/go_trace_ex.png"\n        srcset="/static/275044a153e5f0b30350db08a0b58aa1/5243c/go_trace_ex.png 240w,\n/static/275044a153e5f0b30350db08a0b58aa1/ab158/go_trace_ex.png 480w,\n/static/275044a153e5f0b30350db08a0b58aa1/e5e56/go_trace_ex.png 924w"\n        sizes="(max-width: 924px) 100vw, 924px"\n        style="width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;"\n        loading="lazy"\n        decoding="async"\n      />\n    </span>'}})),"\n",l.createElement(t.p,null,l.createElement(t.a,{href:"https://pangyoalto.com/go-using-pprof-for-profiing/"},"링크2")),"\n",l.createElement(t.hr),"\n",l.createElement(t.h1,null,"분석"),"\n",l.createElement(t.h3,null,"(Flat,cum )[",l.createElement(t.a,{href:"https://ssup2.github.io/programming/Golang_Profiling/"},"https://ssup2.github.io/programming/Golang_Profiling/"),"]"),"\n",l.createElement(t.p,null,"flat is duration spent on given a function and\r\ncum is cumulative of current function plus calls above it"),"\n",l.createElement(t.p,null,"Flat은 함수가 직접적으로 수행하는 Action의 부하\r\nCum은 함수가 실행되기 위한 모든 Action의 부하"),"\n",l.createElement(t.p,null,"sum% could help you to identify the big rocks quickly. The following is another example of memory allocation report.\r\nsum% = 메모리 사용률\r\n메모리 사용률(sum) 이 100% 가 되지 않는 상황"),"\n",l.createElement(t.p,null,"누수는 프로그램이 더 이상 필요하지 않은 메모리를 해제하지 않아 발생하며, 이로 인해 메모리 사용량이 계속해서 증가..\r\n",l.createElement(t.a,{href:"https://stackoverflow.com/questions/32571396/pprof-and-golang-how-to-interpret-a-results"},"https://stackoverflow.com/questions/32571396/pprof-and-golang-how-to-interpret-a-results"),"\r\n",l.createElement(t.a,{href:"https://ssup2.github.io/programming/Golang_Profiling/"},"https://ssup2.github.io/programming/Golang_Profiling/")),"\n",l.createElement(t.p,null,"출력된 그래프를 읽는방법\r\n",l.createElement(t.a,{href:"https://github.com/google/pprof/blob/main/doc/README.md#interpreting-the-callgraph"},"https://github.com/google/pprof/blob/main/doc/README.md#interpreting-the-callgraph")),"\n",l.createElement(t.hr),"\n",l.createElement(t.h1,null,"실제 개발환경에서 테스트"),"\n",l.createElement(t.p,null,"한 서비스에서  배열이 메모리를 잡고있어서\r\n동료가 해당 코드를 삭제해서 개선하셨다고 했다\r\n개선이 되었는지 확인하기 위해 개선전 branch 에서 heap 을 3분간 출력하고\r\n개선후 branch 에서 heap 을 3분간 출력했을때\r\n개선후 그래프 이미지에서 노드 색상이 초록색인 칸들이 추가된것을 볼 수 있었다.\r\n개선된 코드가 메모리를 잡고 있었던 부분을 풀어주고 있다고 동료와는 이야기 했고\r\n출력된 그래프를 읽는방법을 공부하고 이후 운영에서 사용을 고려해 봐야겠다\r\n다른 개발자들은 어떻게 사용하는지 궁금하다.\r\n(인프라 담당자분이 개발계 터미널에서 localhost 로 실행해서 heap 파일을 생성했다)"),"\n",l.createElement(t.hr),"\n",l.createElement(t.p,null,l.createElement(t.a,{href:"https://laeshiny.medium.com/golang-package-pprof-in-net-http-9d34fcb6d675"},"https://laeshiny.medium.com/golang-package-pprof-in-net-http-9d34fcb6d675"),"\r\n",l.createElement(t.a,{href:"https://github.com/google/gops"},"https://github.com/google/gops"),"\r\n",l.createElement(t.a,{href:"https://pangyoalto.com/go-using-pprof-for-profiing/"},"https://pangyoalto.com/go-using-pprof-for-profiing/"),"\r\n",l.createElement(t.a,{href:"https://ssup2.github.io/programming/Golang_Profiling/?ref=pangyoalto.com"},"https://ssup2.github.io/programming/Golang_Profiling/?ref=pangyoalto.com")))}var a=function(e){void 0===e&&(e={});const{wrapper:t}=Object.assign({},(0,r.ah)(),e.components);return t?l.createElement(t,e,l.createElement(o,e)):o(e)},p=n(8804);function c(e){return l.createElement(p.Z,e,l.createElement(a,e))}p.Z}}]);
//# sourceMappingURL=component---node-modules-lekoarts-gatsby-theme-minimal-blog-core-src-templates-post-query-tsx-content-file-path-content-posts-server-golang-2023-08-16-go-profiling-memory-mdx-17a9895a0d58a12b723f.js.map