"use strict";(self.webpackChunkgwiyeom_blog=self.webpackChunkgwiyeom_blog||[]).push([[6916],{5623:function(e,t,n){n.r(t),n.d(t,{Head:function(){return s.p},default:function(){return a}});var r=n(6540),l=n(8453);function o(e){const t=Object.assign({h1:"h1",p:"p",h3:"h3",blockquote:"blockquote",code:"code",a:"a",hr:"hr",ol:"ol",li:"li",pre:"pre",span:"span",h2:"h2"},(0,l.RP)(),e.components);return r.createElement(r.Fragment,null,r.createElement(t.h1,null,"배경"),"\n",r.createElement(t.p,null,"오픈소스 프로젝트에 참가하게 되었고\n그 프로젝트 이슈 중 한가지를 진행하기로 했다\n담당한 이슈는 cors 정책을 지키지 못해서 발생한 문제로\ncors 개념을 공부하고 기록하려고 한다.\n최종적으로 cors 를 발생시키는 상황을 이해하고 테스트 코드를 작성하는 것이다."),"\n",r.createElement(t.h3,null,"CORS 는 뭐고 탄생한 이유?"),"\n",r.createElement(t.p,null,"과거 모놀리식 아키텍쳐(Monolithic architecture) 에서는\n클라이언트와 서버가 합쳐진 일체형 구조였다.\n코드량이 늘어나고 규모가 커져서 관리하기 어려워 졌고 서바랑 클라이언트랑 분리하게 되었다\n이때 웹 출처와 웹 서버의 출처가 달라지게 되는 경우도 많아졌다."),"\n",r.createElement(t.blockquote,null,"\n",r.createElement(t.p,null,"여기서 출처(Origin)가 뭐지?\nURL 구조의 protocol ,hostname, port 를 합친 것을 말하며\n보통 port 는 생략되어 보여도 값이 항상 존재한다\n(URL 의 구조)\n",r.createElement(t.code,null,"[      http      ]://[www.test.org ]:[3000]/[main]? [ page=1]"),"\n",r.createElement(t.code,null,"[protocol(Scheme)]   [ host(domain)] [port] [path]  [query string]")),"\n"),"\n",r.createElement(t.p,null,"웹상에 리소스를 서로 주고 받으면서\n요청을 제한하는 두가지 정책을 만들게 되었다."),"\n",r.createElement(t.blockquote,null,"\n",r.createElement(t.p,null,"1.SOP(Same-Origin Policy) 동일 출처 정책 : 같은 출처에서만 리소스를 공유할 수 있다\n2.",r.createElement(t.a,{href:"https://developer.mozilla.org/en-US/docs/Web/HTTP/CORS"},"Cross-Origin Resource Sharing (CORS)"),"\n다른 출처에 있는 리소스를 가져오는 것은 굉장히 흔한일로\n몇 가지 예외 조항에 해당하는 리소스 요청은 출처가 다르더라도 허용하도록 했는데,\n그 중 하나가 cors 정책을 지킨 리소스 요청이다."),"\n"),"\n",r.createElement(t.p,null,"정리하면\n다른 출처로 리소스를 사용하는것은 SOP 위반\n하지만 예외 조항에 해당하는 CORS 로 리소스 요청이 가능하게 되었는데\nCORS 정책을 위반하게 되었을 때 에러가 발생한다.\n(출처가 일치하지 않으 발생 URL 구조의 protocol ,hostname, port 중 하나라도 일치하지 않으면 발생)"),"\n",r.createElement(t.h3,null,"CORS 와 서버간의 관계는 뭐지?"),"\n",r.createElement(t.p,null,"서버 간 통신을 할 때는 이 정책이 적용되지 않는다\n하지만\nCORS에 정책은 서버에 저장되며\n저장된 CORS 정책을 브라우저에 보내주는 일을 서버가 담당한다"),"\n",r.createElement(t.p,null,"서버에 입력된 출처와 다르면 리소스를 사용할 수 없도록 에러를 반환하고\n검증된다면 허용해주는 응답 헤더를 보낸다."),"\n",r.createElement(t.p,null,"즉 브라우저에게 http 요청이 발생하고 CORS 검증이 필요시\n서버에게 Preflight Request(사전요청)을 한다\n서버는 검증을 하고 문제가 있다면 http 요청을 취소시키고 에러를 발생시킨다"),"\n",r.createElement(t.hr),"\n",r.createElement(t.h3,null,r.createElement(t.a,{href:"https://chuckchoiboi.github.io/cors-tutorial/"},"CORS 3가지 시나리오 체험 사이트")),"\n",r.createElement(t.blockquote,null,"\n",r.createElement(t.p,null,"simple Request"),"\n"),"\n",r.createElement(t.ol,null,"\n",r.createElement(t.li,null,"서버가 응답 헤더 'Access-Control-Allow-Origin' 를 추가 안"),"\n"),"\n",r.createElement(t.pre,null,r.createElement(t.code,null,"\tAccess to fetch at 'https://cors-tutorial-server.herokuapp.com/api/simple/no-origin' from origin 'https://chuckchoiboi.github.io' has been blocked by CORS policy: No 'Access-Control-Allow-Origin' header is present on the requested resource. If an opaque response serves your needs, set the request mode to 'no-cors' to fetch the resource with CORS disabled.\n")),"\n",r.createElement(t.ol,{start:"2"},"\n",r.createElement(t.li,null,"잘못된 출처로 요청을 보냈을 때(출처가 서버에 기록된 값과 다름)"),"\n"),"\n",r.createElement(t.pre,null,r.createElement(t.code,null,"\tAccess to fetch at 'https://cors-tutorial-server.herokuapp.com/api/simple/bad-origin' from origin 'https://chuckchoiboi.github.io' has been blocked by CORS policy: The 'Access-Control-Allow-Origin' header has a value 'https://www.website.notcool' that is not equal to the supplied origin. Have the server send the header with a valid value, or, if an opaque response serves your needs, set the request mode to 'no-cors' to fetch the resource with CORS disabled.\n")),"\n",r.createElement(t.blockquote,null,"\n",r.createElement(t.p,null,"preflight request"),"\n"),"\n",r.createElement(t.ol,null,"\n",r.createElement(t.li,null,"잘못된 출처로 요청을 보냈을 때(출처가 서버에 기록된 값과 다름)"),"\n",r.createElement(t.li,null,'"Access-Control-Allow-Methods" 을 지정하지 않았을'),"\n"),"\n",r.createElement(t.pre,null,r.createElement(t.code,null,"Access to fetch at 'https://cors-tutorial-server.herokuapp.com/api/preflight/bad-method' from origin 'https://chuckchoiboi.github.io' has been blocked by CORS policy: Method DELETE is not allowed by Access-Control-Allow-Methods in preflight response.\n")),"\n",r.createElement(t.ol,{start:"3"},"\n",r.createElement(t.li,null,"preflight request 응답 헤더에는 제대로 작성했는데\n실제 simple rqeust 응답 헤더에 다른 출처를 작성\n둘이 일치하지 않을떄? 제공된 오리진과 다른 경"),"\n"),"\n",r.createElement(t.pre,null,r.createElement(t.code,null,"Access to fetch at 'https://cors-tutorial-server.herokuapp.com/api/preflight/req-bad-origin' from origin 'https://chuckchoiboi.github.io' has been blocked by CORS policy: The 'Access-Control-Allow-Origin' header has a value 'https://www.website.notcool' that is not equal to the supplied origin. Have the server send the header with a valid value, or, if an opaque response serves your needs, set the request mode to 'no-cors' to fetch the resource with CORS disabled.\n")),"\n",r.createElement(t.blockquote,null,"\n",r.createElement(t.p,null,"credentialed request 인증과 관현된 정보를 담을 수 있게 해주는 옵션 :credentials 옵션"),"\n"),"\n",r.createElement(t.ol,null,"\n",r.createElement(t.li,null,"credentials 가 include 이어서 서버에서 \"Access-Control-Allow-Origin\" 값을  '*' 로 끌 수 없다"),"\n"),"\n",r.createElement(t.pre,null,r.createElement(t.code,null,"Access to fetch at 'https://cors-tutorial-server.herokuapp.com/api/credentialed/wildcard-origin' from origin 'https://chuckchoiboi.github.io' has been blocked by CORS policy: The value of the 'Access-Control-Allow-Origin' header in the response must not be the wildcard '*' when the request credentials mode is 'include'.\n")),"\n",r.createElement(t.ol,{start:"2"},"\n",r.createElement(t.li,null,'서버의 응답헤더에 "Access-Control-Allow-Credentials" 값이 true 로 보내지 않았을'),"\n"),"\n",r.createElement(t.pre,null,r.createElement(t.code,null,"Access to fetch at 'https://cors-tutorial-server.herokuapp.com/api/credentialed/good-origin' from origin 'https://chuckchoiboi.github.io' has been blocked by CORS policy: The value of the 'Access-Control-Allow-Credentials' header in the response is '' which must be 'true' when the request credentials mode is 'include'.\n")),"\n",r.createElement(t.hr),"\n",r.createElement(t.h1,null,r.createElement(t.a,{href:"https://developer.mozilla.org/en-US/docs/Glossary/Preflight_request"},"CORS preflight request Caching")),"\n",r.createElement(t.p,null,r.createElement(t.code,null,"CORS Options Request 를 캐싱하여 HTTP Request 를 줄인다."),"\n실제로 오픈소스에 작업해보자"),"\n",r.createElement(t.blockquote,null,"\n",r.createElement(t.p,null,r.createElement(t.a,{href:"https://news.hada.io/topic?id=7453"},"preflight 응답을 캐쉬하는 방법")),"\n"),"\n",r.createElement(t.h1,null,"CORS preflight 를 캐싱해야 하는 이유는?"),"\n",r.createElement(t.p,null,"CORS 검증이 필요시 서버에게 사전요청을 합니다.\n서버는 검증을 하고 문제가 있다면 http 요청을 취소시키고 에러를 발생시킵니다.\n모든 API 요청 전 매번 사전 요청을 발생하기 때문에\n실제 요청에 걸리는 시간이 늘어납니다.\n시간을 줄이고 불필요한 동일 사전요청을 보내지 않게 하기 위해서 브라우저에서 캐싱이 필요합니다."),"\n",r.createElement(t.h1,null,"작업순서"),"\n",r.createElement(t.p,null,"현제 상태를 보니\n기본 cors 설정을 하고 있지만\n응답이 발생할 때 header 에 추가하는 코드가 없었다"),"\n",r.createElement(t.p,null,"브라우저 제한: Firefox는 값을 86400(24시간)으로 제한하는 반면\n모든 Chromium 기반 브라우저는 값을 7200(2시간)으로 제한합니다.\n모든 API 요청 전이 아니라 2시간마다 한 번씩 이 요청을 하면\n사용자 경험이 크게 향상될 수 있으며\n가능한 경우 더 긴 수명이 적용되도록 더 높은 값을 설정하는 것이 쉽게 승리할 수 있습니다.\n",r.createElement(t.a,{href:"https://httptoolkit.com/blog/cache-your-cors/"},"https://httptoolkit.com/blog/cache-your-cors/")),"\n",r.createElement(t.h1,null,"작업내용"),"\n",r.createElement(t.p,null,"처음에는 e.Use 에 미들웨어를 추가하고 테스트 케이스를 작성했다"),"\n",r.createElement(t.pre,null,r.createElement(t.code,null,"\ta.gin.Use(cors.New(a.newCorsConfig()))\n\ta.gin.Use(middlewares.CORSOptionsRequestCaching(a.newCorsConfig()))\n")),"\n",r.createElement(t.pre,null,r.createElement(t.code,null,'func CORSOptionsRequestCaching(corsConfig cors.Config) gin.HandlerFunc {\n\treturn func(c *gin.Context) {\n\t\tif c.Request.Method == "OPTIONS" {\n\t\t\tc.Writer.Header().Set("Access-Control-Max-Age", fmt.Sprintf("%v", corsConfig.MaxAge))\n\t\t\tc.JSON(http.StatusNoContent, "")\n\t\t\treturn\n\t\t}\n\t\tc.Next()\n\t}\n}\n')),"\n",r.createElement(t.pre,null,r.createElement(t.code,null,'func TestCORSOptionsRequestCaching(t *testing.T) {\n\t// given\n\trouter := gin.Default()\n\tcorsConfig := cors.DefaultConfig()\n\tcorsConfig.AllowCredentials = true\n\tcorsConfig.AllowOriginFunc = func(origin string) bool {\n\t\treturn true\n\t}\n\tcorsConfig.AllowHeaders = []string{"Origin", "Content-Length", "Content-Type", "Authorization"}\n\tcorsConfig.MaxAge = 24 * time.Hour\n\n\trouter.Use(cors.New(corsConfig))\n\trouter.Use(CORSOptionsRequestCaching(corsConfig))\n\n\t// when\n\treq := httptest.NewRequest(http.MethodOptions, "/", nil)\n\treq.Header.Add("Origin", "http://testSite.com")\n\n\tw := httptest.NewRecorder()\n\trouter.ServeHTTP(w, req)\n\n\t// then\n\tassert.Equal(t, "86400", w.Header().Get("Access-Control-Max-Age"))\n}\n')),"\n",r.createElement(t.p,null,"그런데 테스트 케이스를 작성하고 테스트 하면서기존 cors 라이브러리에\nMaxAge 를 설정하면 자동으로 사전요청 캐싱을 해준다는 것을 코드를 보고 알았고\n테스트 케이스로 Options 메서드로 요청을 보내니\n응답 헤더에 Access-Control-Max-Age 값이 존재했다.\n그래서 기존 코드로 돌리고\ncorsConfig 값에 MaxAge 값만 ",r.createElement(t.code,null,"24*time.Hours")," 를 설정하는 코드를 작성하고 pull request 를 보냇다."),"\n",r.createElement(t.span,{dangerouslySetInnerHTML:{__html:'<span\n      class="gatsby-resp-image-wrapper"\n      style="position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 476px; "\n    >\n      <span\n    class="gatsby-resp-image-background-image"\n    style="padding-bottom: 52.916666666666664%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAALCAYAAAB/Ca1DAAAACXBIWXMAAA7DAAAOwwHHb6hkAAABlUlEQVR42pWSS0/kMBCE8/9vHPbCChaW/TX70AAHrkAyie3YceIEDTPOo7bamTkgVlqI1Grbsd1fVzkz2mBbbKFrDWUViqLAbrfDPE+MGZ/9stoYNNbDDAa5f0bXdGjbFr5p8Pq6//yFWmlordE4jyEMsHUN5xpM04QYI+IYMY4jxuP8f9RZ3/dofQtrHbouIIQegVnmbdtB/ocQmAfULHY4xHRwWZZ/Rvac53h6ytNk3QhSrOP9fk/atZB8sr4sc6KU8du8jjNHEjkkYa1N7Xvv01hVFek9Aik/alAmB6U9Q3PksrKsUmtlWab1hnpKiCwNL+8pia1dkkG0Fkk8TZTC3nckNDW0Uohsb6bwEw2YxQQx4Jgjs5h0CjEnGXVcj6f97CJz1MexWs0KmhUr0mmSFaS1NMV1HYksqS1JXaI/hRBqvmPHJ1ZWipofkJnNHczdPdTmFuWfDfKfv9O8+MV8ew/38IDh5QXW2VVnuZQynZx+/w4vrqC/3aC6uMb26+Ua55dQV9/xePYFw/UPHC3+kCl/AYhnSp3V4QK9AAAAAElFTkSuQmCC\'); background-size: cover; display: block;"\n  ></span>\n  <img\n        class="gatsby-resp-image-image"\n        alt="img"\n        title=""\n        src="/static/69e1321f9221423cbbc30b3e95c00c92/d9059/preflight_caching_result.png"\n        srcset="/static/69e1321f9221423cbbc30b3e95c00c92/5243c/preflight_caching_result.png 240w,\n/static/69e1321f9221423cbbc30b3e95c00c92/d9059/preflight_caching_result.png 476w"\n        sizes="(max-width: 476px) 100vw, 476px"\n        style="width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;"\n        loading="lazy"\n        decoding="async"\n      />\n    </span>'}}),"\n",r.createElement(t.h1,null,"실제로 회사 코드에 적용해 보니"),"\n",r.createElement(t.p,null,"코드를 적용 후\n개발게에서  기부를 등록하는 api 를 사용해 테스트 했다\n기존 개발계에서 개발자도구를 켜고 네트워크를 보았다\n1.API 호출\n(사전요청)\n(요청)\n2.API 호출\n(사전요청)\n(요청)\n3.API 호출\n(사전요청)\n(요청)\n순서로 매 요청에 사전요청이 나타났다"),"\n",r.createElement(t.p,null,"코드를 적용 후 배포하는 처음 사전요청이 나타나고 응답헤더에 max-age 값이 나타난 것을 확인\n이후 같은 api 호출시 사전요청이 네트워크에서 보이지 않았다."),"\n",r.createElement(t.p,null,"1.API 호출\n(사전요청)\n(요청)\n2.API 호출\n(요청)\n3.API 호출\n(요청)"),"\n",r.createElement(t.h2,null,"참고"),"\n",r.createElement(t.p,null,r.createElement(t.a,{href:"https://velog.io/@wiostz98kr/CORS%EC%9D%98-%EB%AA%A8%EB%93%A0-%EA%B2%83"},"https://velog.io/@wiostz98kr/CORS%EC%9D%98-%EB%AA%A8%EB%93%A0-%EA%B2%83"),"\n",r.createElement(t.a,{href:"https://velog.io/@guswlsapdlf/CORSCross-Origin-Resource-Sharing"},"https://velog.io/@guswlsapdlf/CORSCross-Origin-Resource-Sharing"),"\n",r.createElement(t.a,{href:"https://bourbonkk.tistory.com/63"},"https://bourbonkk.tistory.com/63"),"\n",r.createElement(t.a,{href:"https://brownbears.tistory.com/337"},"https://brownbears.tistory.com/337"),"\n",r.createElement(t.a,{href:"https://www.webperf.tips/tip/optimizing-cors/"},"https://www.webperf.tips/tip/optimizing-cors/"),"\n",r.createElement(t.a,{href:"https://auth0.com/blog/cors-tutorial-a-guide-to-cross-origin-resource-sharing/"},"https://auth0.com/blog/cors-tutorial-a-guide-to-cross-origin-resource-sharing/"),"\n",r.createElement(t.a,{href:"https://echo.labstack.com/middleware/cors/"},"https://echo.labstack.com/middleware/cors/"),"\n",r.createElement(t.a,{href:"https://news.hada.io/topic?id=7453"},"https://news.hada.io/topic?id=7453")))}var c=function(e){void 0===e&&(e={});const{wrapper:t}=Object.assign({},(0,l.RP)(),e.components);return t?r.createElement(t,e,r.createElement(o,e)):o(e)},s=n(7292);function a(e){return r.createElement(s.A,e,r.createElement(c,e))}s.A}}]);
//# sourceMappingURL=component---node-modules-lekoarts-gatsby-theme-minimal-blog-core-src-templates-post-query-tsx-content-file-path-content-posts-etc-2023-02-10-etc-cors-mdx-2de30f54a4c6be4ce253.js.map